/*! frontbone 2013-03-18 */
(function(t){"use strict";var e,n,i,r=[],s=!1,o=!1,c=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.msRequestAnimationFrame||t.oRequestAnimationFrame||function(t){setTimeout(function(){t()},1e3/15)},u=function(t){-1===r.indexOf(t)&&r.push(t)},a=t.ComputedRefresher={refreshAll:function(){_.each(r,function(t){t.notify()}),r=[]},startRefresh:function(){var t=this;s=!0,c(function(){s&&(t.refreshAll(),t.startRefresh())})},stopRefresh:function(){s=!1}};a.startRefresh(),i=function(t){t=t||{};var e=t.initial,n=t.get,i=t.set,r=t.context,s=t.async,c=[],a=[],l=function(t){if(0===arguments.length)n?e=n.call(r):o&&o.dependsOn(l);else if(e!==t||_.isObject(t)){if(i)i.call(r,t);else{if(n)throw Error("Setter for computed is not defined");e=t}s?u(l):l.notify()}return e};return _.extend(l,{dependsOn:function(t){var e=this;return-1===c.indexOf(t)&&(c.push(t),t.subscribe(function(){s?u(l):l.notify()})),e},subscribe:function(t){return a.push(t),this},unsubscribe:function(t){return a=_.filter(a,function(e){return e===t}),this},notify:function(){var t=this,e=t();return(t.lastValue!==e||_.isObject(e))&&_.each(a,function(n){n.call(t,e)}),t.lastValue=e,t},fire:function(){var t=this,e=t();return _.each(a,function(n){n.call(t,e)}),t},callAndSubscribe:function(t){return t.call(this,this()),this.subscribe(t),this},_notSimple:!0,__observable:!0}),l.valueOf=l.toString=function(){return this()},n&&(o=l,e=n.call(r),o=!1),l.lastValue=e,delete l.dependsOn,c=void 0,l},e=function(t){return i({initial:t})},e.isObservable=function(t){return"function"!=typeof t?!1:t.__observable||!1},n=function(t,e,n,r){return i("function"==typeof t?{get:t,context:e,set:r,async:n}:t)},t.BaseObservable=i,t.Observable=e,t.Computed=n})(this),function(t){"use strict";var e=function(){},n=function(){},i=/xyz/.test(function(){alert("xyz")})?/\b_super\b/:/.*/;n.prototype._constructor=Object,n.prototype.constructor=n,n.extend=function(t){var n=this,r=function(){this._constructor.apply(this,arguments)};return t.hasOwnProperty("constructor")&&(t._constructor=t.constructor),e.prototype=n.prototype,r.prototype=new e,_.each(t,function(t,e){r.prototype[e]="function"==typeof t&&void 0===t._notSimple&&i.test(""+t)?function(){var i,r=this._super;return this._super=n.prototype[e],i=t.apply(this,arguments),this._super=r,i}:t}),r.prototype.constructor=r,r._notSimple=!0,r.extend=n.extend,r.create=n.create,r},n.create=function(t){var e,n,i,r=_.toArray(arguments),s=this.extend(t),o="return new child(",c=["child"],u=[s];if(r.shift(),e=r.length,e>0){for(n=0;e>n;n++)o+="arg"+n+", ",c.push("arg"+n),u.push(r[n]);o=o.substr(0,o.length-2)}o+=");",c.push(o);try{i=Function.apply(void 0,c).apply(void 0,u)}catch(a){throw a}return i},t.Class=n}(this),function(t){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){return _.indexOf(this,t,e)});var e=/\s+/,n=".",i=function(t,e,i,r){t+="";var s=t.split(n);return{c:i,s:r,fn:e,n:s[0],ns:s.slice(1),o:t}},r=function(t,e){var n,i;n=t._listeners||{},i=n[e.n]||[],i.push(e),n[e.n]=i,t._listeners=n},s=function(t,e,n,r,s){var o="any"===s?!1:[],c=i(e,n,r);return s||(s="filter"),_.each(t,function(t){return _.each(t,function(t){var e,n=!(c.fn&&c.fn!==t.fn||c.n&&c.n!==t.n||c.c&&c.c!==t.c);if(n&&c.ns.length&&(e=t.ns,n=!_.any(c.ns,function(t){return e.indexOf(t)})),n){if("filter"===s)o.push(t);else if("any"===s)return o=!0,!1}else"invert"===s&&o.push(t)}),o===!0?!1:void 0}),o},o=function(t,e,n,o){var c,u,a;if(t._listeners){if(!e&&!n&&!o)return delete t._listeners,void 0;if(c=i(e,n,o),!c.ns.length&&!n&&!o)return delete t._listeners[c.n],void 0;for(u=s(t._listeners,e,n,o,"invert"),delete t._listeners,a=u.length-1;a>=0;a--)r(t,u[a])}},c=Class.extend({on:function(t,n,s,o){var c,u=this;if(_.isObject(t))return c=n||u,_.each(t,function(t,e){u.on(e,t,c,o)}),this;if("function"!=typeof n)throw TypeError("function expected");return s||(s=this),_.each(t.split(e),function(t){r(u,i(t,n,s,o))}),u},off:function(t,n,i){var r=this;return t?(_.each(t.split(e),function(t){o(r,t,n,i)}),r):(o(r,"",n,i),r)},fire:function(t){if(!this._listeners)return this;var n=_.rest(arguments,1),i=this;return _.each(t.split(e),function(t){_.each(s(i._listeners,t,!1,!1),function(t){t.s&&i.off(0,t.fn),t.fn.apply(t.c,n)})}),i},one:function(t,e,n){return this.on(t,e,n,!0)},hasListener:function(t){return this._listeners?s(this._listeners,t,!1,!1,"any"):!1}});c.prototype.trigger=c.prototype.fire,t.Events=c}(this),function(t){"use strict";var e={},n=Events.extend({constructor:function(t){t=t||{},this.attributes=_.extend({},this.defaults,this.parse(t)),this._changed={},this.id=this.attributes[this.idAttribute],this.cid=_.uniqueId("c"),this.mapping&&this.id&&(e[this.mapping]=e[this.mapping]||{},e[this.mapping][this.id]=this),this.initialize()},initialize:function(){return this},idAttribute:"id",mapping:!1,defaults:{},toJSON:function(){return _.clone(this.attributes)},parse:function(t){return t},baseURL:"/",url:function(){return this.baseURL+(this.mapping?this.mapping+"/":"")+(this.id?this.id+"/":"")},update:function(t){return this.prop(this.parse(t)),this._changed={},this},prop:function(t,e){if(1===arguments.length&&"string"==typeof t)return this.attributes[t];var n={},i=this,r={};return"string"==typeof t?n[t]=e:n=t,_.each(n,function(t,e){r[e]=i._changed[e]=i.attributes[e]=t,e===i.idAttribute&&(i.id=t),i.fire("change:"+e)}),this.fire("change",r),this},get:function(){return this.prop.apply(this,arguments)},set:function(){return this.prop.apply(this,arguments)},validate:function(){return!0},fetch:function(t){t=t||{};var e=this,i={success:function(n){e.update(n),"function"==typeof t.success&&t.success.apply(e,arguments)},error:function(){"function"==typeof t.error&&t.error.apply(e,arguments)}};return n.sync("read",this.url(),_.extend({},t,i)),this},save:function(){var t=this;if(!this.validate())throw Error("Model is invalid");if(this.id){if(0===_.keys(t._changed).length)return this;n.sync("update",this.url(),{data:t._changed,success:function(e){t.update(e)}})}else n.sync("create",this.url(),{data:_.clone(this.attributes),success:function(e){t.update(e)}});return this},remove:function(){this.fire("remove"),this.id&&n.sync("delete",this.url(),{})}});n.fromStorage=function(t,n){return e[t]=e[t]||{},e[t][n]},n.createOrUpdate=function(t,e){var i,r,s,o=t.prototype;return o.mapping&&(r=o.idAttribute,s=o.parse(e),i=n.fromStorage(o.mapping,s[r]))?(i.update(e),i):new t(e)},n.sync=function(t,e,n){n=n||{};var i={method:t};"PUT"===t&&(t="POST"),$.extend(i,n.data),$.ajax({url:e,dataType:"json",type:t,data:i,success:n.success,error:n.error})},t.Model=n}(this),function(t){"use strict";var e=function(t){this.self=t},n=Model.extend({constructor:function(t,n){this.itself=new e(this),this.models=[],this.length=0,this._hashId=[],t&&this.reset(t),this.initialize(n)},models:[],model:Model,url:function(){return this.baseURL+this.model.prototype.mapping+"/"},fetch:function(t){t=t||{};var e=this,n={success:function(n){e.reset(n,t),"function"==typeof t.success&&t.success.apply(e,arguments)},error:function(){"function"==typeof t.error&&t.error.apply(e,arguments)}},i=_.extend({},t,n);Model.sync("GET",this.url(),i)},reset:function(t,e){if(e=e||{},e.add||(this.fire("beforeReset",this.models),this.models=[],this.length=0,this._hashId=[]),!t)return this.fire("reset"),this;var n=this.parse(t);return this.add(n,"end",!e.add),e.add||this.fire("reset"),this},push:function(t){return this.add(t)},unshift:function(t){return this.add(t,0)},add:function(t,e,n){function i(t,e){if(0===e&&o.length)r=o._hashId[0].index-1,o._hashId.unshift({id:t.id,index:r});else{var n=o._hashId.length;r=0===n?1:o._hashId[n-1].index+1,o._hashId.push({id:t.id,index:r})}}var r,s,o=this,c=[],u=0;return t instanceof Array||(t=[t]),"number"!=typeof e?e=this.getIndex(this.models[this.length-1]):0===e&&(s=_.clone(t).reverse(),u=this.getIndex(this.models[0])-s.length-1),_.each(t,function(t,n){t instanceof Model||(t=Model.createOrUpdate(o.model,t)),c.push(t),s?i(s[n],0):i(t,e+n),t.one("remove",function(){o.cutByCid(this.cid)}),o.models.splice(e+n,0,t)}),this.length=this.models.length,n||this.fire("add",c,e,u),this},cut:function(t){var e,n=this;return this.each(function(i,r){return i.id===t?(e=n.cutAt(r),!1):void 0}),e},cutByCid:function(t){var e,n=this;return this.each(function(i,r){return i.cid===t?(e=n.cutAt(r),!1):void 0}),e},shift:function(){return this.cutAt(0)},pop:function(){return this.cutAt()},cutAt:function(t){void 0===t&&(t=this.models.length-1);var e,n=this.models.splice(t,1)[0];return this._hashId.splice(t,1),this.length=this.models.length,e={},e[t]=n,this.fire("cut",e),n},at:function(t){return this.models[t]},get:function(){return this.getByID.apply(this,arguments)},getByID:function(t){var e;return this.each(function(n){return n.id==t?(e=n,!1):void 0}),e},getByCid:function(t){var e;return this.each(function(n){return n.cid==t?(e=n,!1):void 0}),e},getIndex:function(t){if(!t)return 0;var e=this.indexOf(t);return this._hashId[e].index}}),i=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortByDesc","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"],r=function(t){return _.isFunction(t)?t:function(e){return e[t]}},s=["filter","reject"],o=["sortBy","sortByDesc","shuffle"];_.sortByDesc=function(t,e,n){var i=r(e);return _.pluck(_.map(t,function(t,e,r){return{value:t,index:e,criteria:i.call(n,t,e,r)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return-1;if(i>n||void 0===i)return 1}return t.index<e.index?-1:1}),"value")},_.each(i,function(t){n.prototype[t]=function(){return _[t].apply(_,[this.models].concat(_.toArray(arguments)))}}),_.each(s,function(t){e.prototype[t]=function(){var e="filter"===t?"reject":"filter",n=this.self,i=_.toArray(arguments),r=_[t].apply(_,[n.models].concat(i)),s=_[e].apply(_,[n.models].concat(i)),o={};return _.each(s,function(t){o[n.indexOf(t)]=t}),n.models=r,n.length=r.length,n.fire("cut",o),n}}),_.each(o,function(t){e.prototype[t]=function(){var e=this.self,n=_[t].apply(_,[e.models].concat(_.toArray(arguments))),i={};return _.each(n,function(t,n){i[e.indexOf(t)]=n}),e.models=n,e.length=n.length,e.fire("sort",i),e}}),t.Collection=n}(this),function(t){"use strict";var e=t.$,n=/\s+/,i=/\s*;\s*/,r=/^[a-z]+$/,s=/^\s*([^:]+)\s*:\s*([\s\S]*\S)\s*$/,o=/^\{([\s\S]*)\}$/,c=/\s*,\s*/,u={setElement:function(t){return this.undelegateEvents(),this.el=t,this.$el=e(t),this.parse().delegateEvents(),this},constructor:function(t){t=t||{},this.options=t,t.collection&&(this.collection=t.collection),this.model=t.model,t.el&&(this.el=t.el);var n=this;n._cid||(n._cid=_.uniqueId("vm")),n.el||(n.el="div"),"string"==typeof n.el&&(n.el=r.test(n.el)&&"html"!==n.el&&"body"!==n.el?document.createElement(n.el):e(n.el)[0]),n.$el=e(n.el),n.$=function(t){return n.$el.find(t)},n.initialize(),n.autoParseBinds&&n.parse(),n.delegateEvents()},remove:function(){return this.$el.remove(),this},parse:function(){return u.findBinds(this.el,this),this},bindToModel:function(t){var e=Observable(new Model(t)),n=e(),i={},r=this;return e.callAndSubscribe(function(t){n&&n.off(0,0,i),n=t,t&&t.on("change",function(t){_.each(t,function(t,e){r[e]&&r[e].fire()})},i)}),this._bindedToModel||_.each(n.attributes,function(t,n){r[n]=Computed(function(){var t=e();return t?t.prop(n):""})}),this._bindedToModel=!0,e},autoParseBinds:!1,initialize:function(){},delegateEvents:function(t){t=t||this.events,this.undelegateEvents();var e,i,r=this;return _.each(t,function(t,s){var o,c="function"==typeof t?t:r[t];if("function"!=typeof c)throw TypeError(t+" is not a function");e=s.split(n),i=e.shift().split(",").join("."+r._cid+" ")+"."+r._cid,o=_.bind(c,r),e.length?r.$el.delegate(e.join(" "),i,o):r.$el.bind(i,o)}),this},undelegateEvents:function(){return this.$el.unbind("."+this._cid),this},render:function(){return this}};u=Events.extend(u),u.compAsync=!0,u.findObservable=function(t,e,n){if(n=n||{},"string"!=typeof e)throw new TypeError("String expected");Observable.isObservable(t)&&(t=t());var i,r,s,o,c=[],u=[];return _.each(n,function(t,e){c.push(e),u.push(t)}),c.push("with(this) return "+e),i=Function.apply(t,c),s=function(){try{return i.apply(t,u)}catch(n){console.log('Error "'+n.message+'" in expression "'+e+'" Context: ',t)}},o=s(),this.compAsync?(Observable.isObservable(o)||(o=s),r=BaseObservable({async:!0,get:function(){return o()},set:function(t){o(t)}})):r=Observable.isObservable(o)?o:Computed(function(){return s()},t),r},u.findBinds=function(t,n,r){var o,a,l,f,h,d,p,v,b,m,_,y,g,O=!1,x=this,A=e(t);if(o=A.attr("data-bind"),A.removeAttr("data-bind"),o)for(a=o.split(i),l=0,p=a.length;p>l;l++)for(v=a[l],g=v.match(s),g?(m=g[1],_=g[2]):(m=v,_=""),m=m.split(c),f=0,h=m.length;h>f;f++)b=m[f],b&&"!"!==b.charAt(0)&&(y=u.binds[b],y?(d=y.call(x,t,_,n,r),d===!1?O=!0:d&&(n=d)):console.warn('Bind: "'+b+'" not exists'));O||A.children().each(function(){x.findBinds(this,n,r)})},u.parseOptionsObject=function(t){var e,n,i;if(!t)return{};if(e=t.match(o),!e||void 0===e[1])throw Error('Expression: "'+t+'" is not valid object');return n=e[1].split(c),n.length?(i={},_.each(n,function(n){if(n){if(e=n.match(s),!e||!e[1]||!e[2])throw Error('Expression: "'+t+'" is not valid object');i[e[1]]=e[2]}}),i):{}},t.ViewModel=u}(this),function(){"use strict";ViewModel.binds={log:function(t,e,n,i){this.findObservable(n,e,i).callAndSubscribe(function(){console.log(n,".",e,"=",this())})},src:function(t,e,n,i){this.findObservable(n,e,i).callAndSubscribe(function(e){t.src=e||""})},html:function(t,e,n,i){this.findObservable(n,e,i).callAndSubscribe(function(e){e||(e=""),t.innerHTML=e})},text:function(t,e,n,i){var r=$(t);this.findObservable(n,e,i).callAndSubscribe(function(t){r.text(t)})},"with":function(t,e,n,i){return this.findObservable(n,e,i)()},each:function(t,e,n,i){var r=this.findObservable(n,e,i),s=$(t),o=s.html();return s.empty(),i=i?_.clone(i):{},r.callAndSubscribe(function(t){s.empty(),t&&_.each(t,function(e,n){i.$index=n,i.$parent=t,i.$value=e;var r=document.createElement("div");r.innerHTML=o,ViewModel.findBinds(r,e,i),s.append(r.innerHTML)})}),!1},value:function(t,e,n,i){var r=$(t),s=this.findObservable(n,e,i).callAndSubscribe(function(t){r.val(t)});r.change(function(){s(r.val())})},attr:function(t,e,n,i){_.each(this.parseOptionsObject(e),function(e,r){ViewModel.findObservable(n,e,i).callAndSubscribe(function(e){e!==!1&&void 0!==e&&null!=e?t.setAttribute(r,e):t.removeAttribute(r)})})},style:function(t,e,n,i){var r=$(t);_.each(this.parseOptionsObject(e),function(t,e){ViewModel.findObservable(n,t,i).callAndSubscribe(function(t){r.css(e,t)})})},css:function(t,e,n,i){var r=$(t);_.each(this.parseOptionsObject(e),function(t,e){ViewModel.findObservable(n,t,i).callAndSubscribe(function(t){t?r.addClass(e):r.removeClass(e)})})},display:function(t,e,n,i){var r=$(t);this.findObservable(n,e,i).callAndSubscribe(function(t){t?r.show():r.hide()})},click:function(t,e,n,i){var r=this.findObservable(n,e,i)(),s=$(t);s.click(function(){r.apply(n,arguments)})}}}(),function(){"use strict";var t={},e={};ViewModel.tmpl={getRawTemplate:function(e){return t[e]},get:function(n,i){var r,s=e[n];if(!s){if(r=t[n],!r)throw Error('Raw tempalte: "'+n+'" is not defined');e[n]=s=i(r)}return s}},ViewModel.binds.template=function(e,n){var i=$(e);return t[n]=i.html(),i.remove(),!1}}(),function(){"use strict";var t=function(t,e,n,i,r){if(!e())throw Error("Model for withModel must not be empty");var s,o,c={};return _.each(e().toJSON(),function(t,e){c[e]=BaseObservable({initial:t})}),_.extend(i,{$self:e,$parent:BaseObservable({initial:n})}),e.callAndSubscribe(function(t){o&&o.off(0,0,r),t?(t.on("change",function(t){_.each(t,function(t,e){c[e]&&c[e](t)})},r),_.each(c,function(e,n){c[n](t.attributes[n])})):_.each(c,function(t){t("")}),o=t}),s=ViewModel.compAsync,ViewModel.compAsync=!1,t.each(function(){ViewModel.findBinds(this,c,i)}),ViewModel.compAsync=s,i},e=function(e,n,i,r,s,o){var c,u,a=document.createElement(i);return a.innerHTML=n,u=$(a).children(),c=t(u,BaseObservable({initial:r}),s,{$index:BaseObservable({initial:o})},e),{$children:u,tempDiv:a,args:c}},n=function(t,e,n,i,r,s){s.on("change",function(){var r=i.indexOf(s),o=t.children();o.slice(r,r+e).empty().remove(),o.eq((r-1)*e).after(n(s,r,i))},r)};ViewModel.binds.withModel=function(e,n,i,r){return r=r||{},t($(e).children(),this.findObservable(i,n,r),i,r,{}),!1},ViewModel.binds.eachModel=function(t,i,r,s){var o,c,u,a,l=$(t),f={},h=t.tagName.toLowerCase();try{o=this.parseOptionsObject(i)}catch(d){}return o||(c=i.split(/\s*,\s*/),o={},o.collection=c[0],o.templateName=c[1]),a=o.templateName?"":l.html(),this.findObservable(r,o.collection,s).callAndSubscribe(function(t){u&&(u.off(0,0,f),o.listenModels&&u.each(function(t){t.off(0,0,f)})),u=t,l.empty();var i,r,s,c;t&&(i=1,r=o.innerBinds?function(t){return function(n,r,s){var o=e(f,t,h,n,s,r).$children;return i=o.length,o}}:function(n){var r=e(f,n,h,new t.model,t,void 0),s=r.tempDiv,o=r.args;return i=r.$children.length,function(t,e,n){return o.$self(t),o.$index(e),o.$parent(n),s.innerHTML}},s=o.templateName?ViewModel.tmpl.get(o.templateName,r):r(a),c=function(){var e=0,r="";l.empty(),o.innerBinds?t.each(function(n){l.append(s(n,e++,t))}):(t.each(function(c){r+=s(c,e++,t),o.listenModels&&n(l,i,s,t,f,c)}),l.html(r))},c(),t.on("add",function(e,r,c){var u=0,a="",d=c||r;o.innerBinds?(a=$(document.createElement(h)),_.each(e,function(e){a.append(s(e,d+u++,t))}),a=a.children()):_.each(e,function(e){a+=s(e,d+u++,t),o.listenModels&&n(l,i,s,t,f,e)}),0===r?l.prepend(a):r&&r!==t.length-e.length?l.children().eq(r*i).before(a):l.append(a)},f),o.listenModels&&t.on("beforeReset",function(t){_.each(t,function(t){t.off(0,0,f)})},f),t.on("reset",c,f),t.on("cut",function(t){var e=l.children();_.each(t,function(t,n){n*=1,t.off(0,0,f),e.slice(n,n+i).empty().remove()})},f),t.on("sort",function(t){var e=$(document.createElement("div")),n=l.children();_.each(t,function(t,r){r*=1,e.append(n.slice(r,r+i))}),l.append(e.children())},f))}),!1},ViewModel.binds.eachModelLight=ViewModel.binds.eachModel}();